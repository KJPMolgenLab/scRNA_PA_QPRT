---
title: "Additional_Analysis"
output: html_document
date: "2023-11-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Call required libraries}
library(scCustomize)
library(dplyr)
library(Seurat)
library(RColorBrewer)
library(ggplot2)
```

## Calling the scRNA data
```{r Calling the ref files}
seurat_integrated<-readRDS("../Data/seurat_integrated.rds")
scRNA.sce <- as.SingleCellExperiment(seurat_integrated)

```

##Identify the proportion of cell type for Yoon clusters
```{r Calling the ref files}

Yoon_reference<-readRDS("yoon_seurat_object_res03_final.rds")

Yoon_reference <- subset(Yoon_reference,cells = WhichCells(Yoon_reference, downsample = 200))

Yoon_reference <- SCTransform(Yoon_reference, ncells = 3000, verbose = FALSE, method = "poisson") %>%
  RunPCA(verbose = FALSE) %>%
  RunUMAP(dims = 1:30)

AR<- as.SingleCellExperiment(Yoon_reference)

pred.hneurons<-SingleR(test = scRNA.sce,ref = AR,labels = AR$ident)


cdata = cbind(colData(scRNA.sce), 
              data.frame(HumanNeurons.label = pred.hneurons$pruned.labels))

rescounts = table(pred.hneurons$pruned.labels, useNA="ifany")
othercells = names(rescounts)[rescounts<100]

cdata$Neurons100.label = pred.hneurons$pruned.labels
cdata$Neurons100.label[cdata$Neurons100.label %in%othercells] = "other"

Neuronpalette = colorRampPalette(brewer.pal(12, "Paired"))(length(unique(cdata$Neurons100.label)))
names(Neuronpalette) = unique(cdata$Neurons100.label)
Neuronpalette["other"] = "gray30"

colData(scRNA.sce) = cdata

# Adding reduced dims to the seurat converted object

umap<-Embeddings(seurat_integrated,"umap")[,]
reducedDim(scRNA.sce, "UMAP")<-umap

pca<-Embeddings(seurat_integrated,"pca")[,]
reducedDim(scRNA.sce, "PCA")<-pca

tsne<-Embeddings(seurat_integrated,"tsne")[,]
reducedDim(scRNA.sce, "TSNE")<-tsne


colData(scRNA.sce)$UMAP1<-data.frame(reducedDim(scRNA.sce)[,1])
colData(scRNA.sce)$UMAP2<-data.frame(reducedDim(scRNA.sce)[,2])

scRNA.sce$UMAP1<-as.numeric(scRNA.sce$UMAP1$reducedDim.scRNA.sce....1.)
scRNA.sce$UMAP2<-as.numeric(scRNA.sce$UMAP2$reducedDim.scRNA.sce....2.)

YoonProp<-seurat_integrated

YoonProp <- AddMetaData(
  object = YoonProp,
  metadata = scRNA.sce$HumanNeurons.label,
  col.name = 'CellType'
)
Idents(YoonProp) <- YoonProp$CellType

#basic plot of clusters by Cell Type
pdf("CellTypeVsSeuratClusters_Yoon.pdf")
ggplot(KnoblichProp@meta.data, aes(x=integrated_snn_res.0.8, fill=CellType)) + geom_bar()
dev.off()


```

##Identify the proportion of cell type for Knoblich clusters
```{r Proportion plots for Knoblich data}
scRNA.sce <- as.SingleCellExperiment(seurat_integrated)

knoblich_reference <- Modules

knoblich_reference <- subset(knoblich_reference, cells = WhichCells(knoblich_reference, downsample = 200))

Idents(knoblich_reference) <- knoblich_reference$celltype_cl_coarse

knoblich_reference <- SCTransform(knoblich_reference, ncells = 3000, verbose = FALSE, method = "poisson") %>%
  RunPCA(verbose = FALSE) %>%
  RunUMAP(dims = 1:30)



AR<- as.SingleCellExperiment(knoblich_reference)
pred.hneurons<-SingleR(test = scRNA.sce,ref = AR,labels = AR$celltype_cl_coarse)


cdata = cbind(colData(scRNA.sce), 
              data.frame(HumanNeurons.label = pred.hneurons$pruned.labels))

rescounts = table(pred.hneurons$pruned.labels, useNA="ifany")
othercells = names(rescounts)[rescounts<100]

cdata$Neurons100.label = pred.hneurons$pruned.labels
cdata$Neurons100.label[cdata$Neurons100.label %in%othercells] = "other"

Neuronpalette = colorRampPalette(brewer.pal(16, "Paired"))(length(unique(cdata$Neurons100.label)))
names(Neuronpalette) = unique(cdata$Neurons100.label)
Neuronpalette["other"] = "gray30"

colData(scRNA.sce) = cdata

# Adding reduced dims to the seurat converted object

umap<-Embeddings(seurat_integrated,"umap")[,]
reducedDim(scRNA.sce, "UMAP")<-umap

pca<-Embeddings(seurat_integrated,"pca")[,]
reducedDim(scRNA.sce, "PCA")<-pca

tsne<-Embeddings(seurat_integrated,"tsne")[,]
reducedDim(scRNA.sce, "TSNE")<-tsne


colData(scRNA.sce)$UMAP1<-data.frame(reducedDim(scRNA.sce)[,1])
colData(scRNA.sce)$UMAP2<-data.frame(reducedDim(scRNA.sce)[,2])

scRNA.sce$UMAP1<-as.numeric(scRNA.sce$UMAP1$reducedDim.scRNA.sce....1.)
scRNA.sce$UMAP2<-as.numeric(scRNA.sce$UMAP2$reducedDim.scRNA.sce....2.)

KnoblichProp<-seurat_integrated

KnoblichProp <- AddMetaData(
  object = KnoblichProp,
  metadata = scRNA.sce$HumanNeurons.label,
  col.name = 'CellType'
)
Idents(KnoblichProp) <- KnoblichProp$CellType

#basic plot of clusters by replicate
pdf("CellTypeVsSeuratClusters_Knoblich.pdf")
ggplot(KnoblichProp@meta.data, aes(x=integrated_snn_res.0.8, fill=CellType)) + geom_bar()
dev.off()

################################################################################################################ 

#set the order of clusters in dataset w clusters
#factor(KnoblichProp@meta.data$integrated_snn_res.0.8, levels=c(seq(0,15)))
#KnoblichProp@meta.data$integrated_snn_res.0.8 <- factor(KnoblichProp@meta.data$integrated_snn_res.0.8, #levels=c(seq(0,15)))
#ggplot(KnoblichProp@meta.data, aes(x=integrated_snn_res.0.8, fill=CellType)) + geom_bar()

# #set custom order to dataset w 30 clusters
# my_levels <- seq(0,15,1)
# factor(KnoblichProp@meta.data$integrated_snn_res.0.8, levels= my_levels)
# KnoblichProp@meta.data$integrated_snn_res.0.8 <- factor(KnoblichProp@meta.data$integrated_snn_res.0.8, levels= my_levels)
# ggplot(KnoblichProp@meta.data, aes(x=integrated_snn_res.0.8, fill=CellType)) + geom_bar()
# 
# #plot as proportion or percentage of cluster
# ggplot(KnoblichProp@meta.data, aes(x=integrated_snn_res.0.8, fill=CellType)) + geom_bar(position = "fill")

###############################################################################################################

```

##Identify differentially expressed genes

```{r Identify DE genes between 0mM and 5mM }

seurat_integrated$cond<-paste(seurat_integrated$orig.ident,seurat_integrated$seurat_clusters, sep = "_")

Idents(seurat_integrated) <- "cond"


Clusters<-list()
for(i in seq(0, 15, 1)){
  Clusters[[i]]<- FindMarkers(seurat_integrated, ident.1 = paste("S05",i,sep="_"), ident.2 = paste("S06",i,sep="_"), verbose = FALSE)
  write.table(Clusters[[i]],paste("S05_06",i,sep="_"),sep="\t")
  }


```

# Search for differentially expressed genes wrt to each cluster e.g Cluster 1 against all other clusrer
# Looking for only positive markers (can be changed by changing the argument only.pos)

```{r Identify DE genes for each cluster against other clusters }
Idents(seurat_integrated) <- "seurat_clusters"

ClusterDEmarkers<-list()
for(i in seq(0, 15, 1)){
ClusterDEmarkers[[i]] <- FindMarkers(seurat_integrated, ident.1 = i, ident.2 = NULL, only.pos = TRUE)
write.table(ClusterDEmarkers[[i]],paste("DE_Overall",i,sep="_"),quote=FALSE)
}
```

## Highlight one cluster at one time

```{r Clusters single }
for(i in seq(0, 15, 1)){
  pdf(paste("Highlight_cluster",i,".pdf",sep=""))
  Cluster_Highlight_Plot(seurat_object = seurat_integrated, cluster_name = i, highlight_color = "navy",
                       background_color = "lightgray")
dev.off()
}
```



## Find markers and limit to those expressed in greater than 75% of target population

```{r Markers expressed }
all_markers <- FindAllMarkers(object = seurat_integrated) %>%
  Add_Pct_Diff() %>%
  filter(pct_diff > 0.6)

top_markers <- Extract_Top_Markers(marker_dataframe = all_markers, num_genes = 7, named_vector = FALSE,
                                   make_unique = TRUE)

pdf("TopMarkers_Expressed75percent.pdf")
Clustered_DotPlot(seurat_object = seurat_integrated, features = top_markers)
dev.off()
```

##Plotting Knoblich Gene lists

```{r Kanton Gene list }
Modules<-readRDS("../Data/Knoblich/CHOOSE_ASD_Modules.rds?download=1") #  27783 28344 (Genes x Columns)
#GE<-readRDS("../CHOOSE_ASD_GE.rds?download=1")
#Multiome<-readRDS("../CHOOSE_Multiome.rds?download=1")

expr_mat <-  Modules@assays$RNA@misc$summary$celltype_cl_coarse
clust_order <- expr_mat %>% dist() %>% hclust(method='ward.D2') %>% {.$label[.$order]}


Knoblich_reference <- Modules

Idents(Knoblich_reference) = Knoblich_reference$integrated_snn_res.0.3
markers_knoblich <- FindAllMarkers(object = Knoblich_reference, 
                          only.pos = TRUE,
                          logfc.threshold = 0.25)  

write.table(markers_knoblich[,c(6,7)],"Knoblich_GeneList.txt",sep="\t",quote = F,row.names=FALSE)
write.table(markers_knoblich,"Knoblich_Markers.txt",sep="\t",quote = F,row.names=FALSE)

##################################

pbmc_small <- FindClusters(Knoblich_reference, resolution = 0.5)

names(pbmc_small@meta.data)[names(pbmc_small@meta.data)=="seurat_clusters"] <- "cluster_names"
levels(pbmc_small$cluster_names) <- paste0("cluster_", seq_along(levels(pbmc_small$cluster_names)))



setNames(lapply(levels(pbmc_small$cluster_names), function(x) {
  p <- subset(pbmc_small, cluster_names==x)
  rownames(p)[Matrix::rowSums(p@assays$RNA@counts > 0) >= .1*dim(p)[2]]
}), levels(pbmc_small$cluster_names))


##################################




KG<-read.table("../Knoblich_GeneList.txt",sep="\t",header=T)

Cluster_Groups<-split(KG, KG$cluster)

for(i in 1:length(Cluster_Groups)){
seurat_integrated<- AddModuleScore(
  object = seurat_integrated,
  features =list(Cluster_Groups[[i]]$gene),name=unique(Cluster_Groups[[i]]$cluster)
)
}

for(i in 1:length(Cluster_Groups)){
pdf(unique(paste(i,".pdf",sep="")))
print(FeaturePlot(seurat_integrated,features = unique(paste(Cluster_Groups[[i]]$cluster,1,sep = "")), label = TRUE, repel = TRUE) +
  scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))))
dev.off()
}
```