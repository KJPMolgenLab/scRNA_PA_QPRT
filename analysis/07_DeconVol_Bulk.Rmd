---
title: "Deconvolution"
author: "A Chiocchetti"
date: "2024-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(SingleR)
library(DropletUtils)
library(SingleCellExperiment)
library(Seurat)
library(slingshot)
library(gprofiler2)
library(tidyverse)
library(MuSiC)
library(ggstream)
```

```{r}
options(stringsAsFactors = F)
set.seed(157434538)
reanalyze=F
cutoff = 0.05 # pavalue cutoff for DEG
padj_cu=FALSE # use adjusted pvalue 
Dark8 = RColorBrewer::brewer.pal(8, "Dark2")
```

```{r getdata}
output= paste0("output/07_Bulk_Deconv/")
dir.create(output, showWarnings = F)
source("code/custom_functions.R")
ddsMat <- readRDS("data/Bulk_dds_matrix.rds")
SampleInfo = as.data.frame(colData(ddsMat))
log_2cpm=log2(counts(ddsMat, normalize=T)+1)
SamplePalette =  c("#000000","#3399FF")

seurat_integrated <- readRDS("./data/QC_dataClustered.filtTypedTraj.rds")
sce.RNA <- as.SingleCellExperiment(seurat_integrated)
metadata<- seurat_integrated@meta.data
```

```{r}
bulk.mtx = counts(ddsMat)
bulk.meta = colData(ddsMat)
bulk.gene = rowData(ddsMat)
rownames(bulk.mtx) = bulk.gene$hgnc[match(rownames(bulk.mtx), bulk.gene$entrez_gene)]
genes = intersect(rownames(sce.RNA), bulk.gene$hgnc)

bulk.mtx=bulk.mtx[genes, ]
sce.RNA <- sce.RNA[genes,]

Est.prop.bulk = music_prop(bulk.mtx = bulk.mtx, sc.sce = sce.RNA, 
                           clusters = 'seurat_clusters',
                           samples = 'orig.ident', verbose = F)



prop.matrix = t(data.matrix(Est.prop.bulk$Est.prop.weighted))
```


# proportion organoid clusters (our experiment)

## longitudinal trajectories of proportions

```{r, fig.width=8, fig.height=8}
long_prop_matrix <-reshape2::melt(prop.matrix)
colnames(long_prop_matrix) <-c("Cluster", "Sample", "Proportion")
metadata_bulk <- as.data.frame(colData(ddsMat))
long_prop_matrix <- cbind(long_prop_matrix,metadata_bulk[long_prop_matrix$Sample,])

p<-ggplot(long_prop_matrix, aes(x=Day, y=Proportion, col=PAmM, fill=PAmM))+
  geom_smooth(method = "loess", alpha = 0.2)+facet_wrap(~Cluster)+theme_classic()
p
ggsave(paste0(output, "07_DeconVol_Bulk_timeplots_clusters.svg"), p)
```

## testing time differences per cluster 

Model: Proportion ~ Day x PamM, corrected for random Batch effects,including Main effects

```{r}
library(lme4)

clustervar = "Cluster"
lmatrix = long_prop_matrix

test_time_by_PA = function(lmatrix, clustervar){
  reslist=list()
  for(cl in unique(lmatrix[,clustervar])){
    dataset = lmatrix[lmatrix[,clustervar]==cl, ]
    if(var(dataset$Proportion) != 0){
      lmres=lmer(Proportion~poly(Day,2)*PAmM+(1|Batch), data = dataset)
      res = car::Anova(lmres, type=3)%>% as.data.frame()
      colnames(res) <- c("Chisq", "df", "pvalue")
      reslist[[as.character(cl)]] <- res 
    } else {
      reslist[[as.character(cl)]] <- data.frame("pvalue"=rep("no var",4))
    }
  } 
  return(reslist)
}

testres = test_time_by_PA(lmatrix = long_prop_matrix, clustervar = "Cluster")

pvals=lapply(testres, function(x){x[4,"pvalue"]})
Significances = data.frame(cluster = names(pvals), p.value = unlist(pvals,recursive = F))
Significances

openxlsx2::write_xlsx(Significances, paste0(output,"07_DeconVol_Bulk_StatTimecourseDiff_clusters.xslx"))
```

## Heatmap proportions across sampels and clusters

Columns add up to 1 i.e. 100% of cells 

```{r, fig.height=8, fig.width=6}

col=viridis::viridis(100)

svg(paste0(output, "07_DeconVol_Bulk_propHeatmap_clusters.svg"))
gplots::heatmap.2(prop.matrix, margins = c(15,10), main = "organoid clusters",cexCol = 0.3,
Colv = F, trace = "none", density.info = "none", col = col, key.title = "prop", key.xlab = "proportion", key.par = list(mar=c(5,2,5,2)))
dev.off()

gplots::heatmap.2(prop.matrix, margins = c(15,10), main = "organoid clusters", cexCol = 0.3,
Colv = F, trace = "none", density.info = "none", col = col, key.title = "prop", key.xlab = "proportion", 
key.par = list(mar=c(5,2,5,2)))

```
# proportion knoblich cell types 

```{r}
sceRNAknoblich <- readRDS("data/Knoblich/CHOOSE_ASD_Modules.rds")
Idents(sceRNAknoblich) <- "celltype_cl_coarse"
sceRNAknoblich <- subset(sceRNAknoblich, cells = WhichCells(sceRNAknoblich, downsample = 500))
sceRNAknoblich<- as.SingleCellExperiment(sceRNAknoblich)

Est.prop.bulk.knblich = music_prop(bulk.mtx = bulk.mtx, sc.sce = sceRNAknoblich, 
clusters = 'celltype_cl_coarse',
samples = 'orig.ident', verbose = F)

prop.matrix.knblich = t(data.matrix(Est.prop.bulk.knblich$Est.prop.weighted))

```

## longitudinal trajectories of proportions

```{r}
long_prop_matrix <-reshape2::melt(prop.matrix.knblich)
colnames(long_prop_matrix) <-c("Kn.Cluster", "Sample", "Proportion")
metadata_bulk <- as.data.frame(colData(ddsMat))
long_prop_matrix <- cbind(long_prop_matrix,metadata_bulk[long_prop_matrix$Sample,])

p<-ggplot(long_prop_matrix, aes(x=Day, y=Proportion, col=PAmM, fill=PAmM))+
geom_smooth(method = "loess", alpha = 0.2)+facet_wrap(~Kn.Cluster)+theme_classic()
p
ggsave(paste0(output, "07_DeconVol_Bulk_timeplots_Knoblichclusters.svg"), p)
```
## testing time differences per cell type 

```{r}
testres = test_time_by_PA(lmatrix = long_prop_matrix, clustervar = "Kn.Cluster")

pvals=lapply(testres, function(x){x[4,"pvalue"]})
Significances = data.frame(cluster = names(pvals), p.value = unlist(pvals,recursive = F))
Significances

openxlsx2::write_xlsx(Significances, paste0(output,"07_DeconVol_Bulk_StatTimecourseDiff_KnCelltypes.xslx"))

```

## Heatmap proportions across sampels and clusters

```{r, fig.height=8, fig.width=6}
svg(paste0(output, "07_DeconVol_Bulk_propHeatmap_Knoblichclusters.svg"))
gplots::heatmap.2(prop.matrix.knblich, scale = "col", cexCol = 0.3,
margins = c(12,5), main = "knoblich clusters",
Colv = F, trace = "none", density.info = "none", col = col, key.title = "prop", key.xlab = "proportion", key.par = list(mar=c(5,2,5,2)))

dev.off()

gplots::heatmap.2(prop.matrix.knblich, scale = "col", cexCol = 0.3, 
margins = c(12,5), main = "knoblich clusters",
Colv = F, trace = "none", density.info = "none", col = col, key.title = "prop", key.xlab = "proportion", key.par = list(mar=c(5,2,5,2)))

```








